#!/usr/bin/env python3

from pwn import *
from extend_mt19937_predictor import ExtendMT19937Predictor

predictor = ExtendMT19937Predictor()


HOST='127.0.0.1'
PORT=5000

io = remote(HOST,PORT)

io.recvuntil('>> ')
Response_for_skip_cutscene='skip'
io.sendline(Response_for_skip_cutscene)  #Skipping cutscene to reduce wait time

Response_initial = 'tank'  #Tanking all damage to get a predictable number of tries at the end
Response_counter = 0

while True:
    options = ['parry', 'slash', 'sweep', 'blitz', 'smite', 'thrust']
    Response_counter += 1

    if Response_counter == 179:  #Boss loses at 179 if all hits are tanked and then countered after 78th try
        io.interactive()
    
    else:
     
        io.recvuntil(">> ")

        if Response_counter > 78:

            Predictor=predictor.predict_getrandbits(256)
            player_counternum = Predictor % 6
            player_countermove = options[(player_counternum-1)%6]
            
            io.sendline(player_countermove)
            print('Move countered.')
            
            io.recvline()
            
            confirmation = io.recvline()
            print(confirmation) 

        else:

            io.sendline(Response_initial)
            print(Response_initial)
            
            io.recvuntil("Atop of the Entity's head something mysterious appears... '")
            mysterious_value = int(io.recvuntil("'")[:-1])
            print(mysterious_value)
            
            predictor.setrandbits(mysterious_value, 256) 

    
    print(Response_counter) #Visual confirmation :) 


